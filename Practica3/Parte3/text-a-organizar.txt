Posee tres registros internos, de ocho bits, accesibles por el programador: registros de datos de entrada, registros de datos de salida y registro de control.
-Registro de entrada: De donde la CPU leerá el dato recibido por la línea serie.
- Registro de salida: Donde se ha de escribir el dato a enviar a la línea serie
- Registro de control: Dependiendo del tipo de acceso, actúa como registro de control o de estado:
- En escritura: Permite programar las características de la transmisión y establecer el estado de algunas señales.
- En lectura: Permite conocer el estado de ciertas líneas y errores en la comunicación; error de trama, error de rebosamiento e interrupción de la línea.
- Características de la transmisión: 8 bits/dato. - Dos posibles velocidades de transmisión:
- V1 = 6 baudios.
- V2 = 18 baudios.
- Permite programar el modo de la comunicación; síncrona o asíncrona, con las siguientes características:
Comunicación síncrona:
- 1 carácter de sincronismo
- Posibilidad de inserción y reconocimiento automático de caracteres de sincronismo. Comunicación asíncrona:
- Sin paridad.
- 1 bit de parada
- 1 bit de arranque
El control de la comunicación se lleva a cabo a través del registro de control que permite definir las características de la misma, conocer los errores ocurridos, así como monitorizar el estado de las señales de protocolo del controlador. Todo ello se logra accediendo, tanto en lectura como en escritura, a dicho registro cuyo formato se describe en las siguientes figuras.


En el sistema, los registros de la USART se sitúan a partir de la dirección 60H. Su conexión en el sistema, se lleva a cabo a través de la configuración 4, donde está conectada a la CPU, mediante el PIC, y a la impresora serie. El modo de conexionado de las líneas de este controlador de comunicaciones serie, es el que se muestra en la siguiente figura en base a una correspondencia de colores.

La Impresora ASCII de 20 columnas que se muestra en la imagen anterior es capaz de mostrar el contenido que se le envía. Aunque muy lenta, para que sean observables los efectos en los accesos de PCs a periféricos de este tipo, el comportamiento es totalmente similar al de una impresora real. Sus características son:
- Velocidad de impresión, un carácter cada cinco segundos.
- Interfaz de E/S serie RS-232-C simplificado.
- Buffer de recepción con capacidad de almacenamiento para 5 caracteres. - Características de la comunicación:
-8 bits/dato.
Dos posibles velocidades de transmisión:
- V1 = 6 baudios.
- V2 = 18 baudios. Sin paridad.
Un bit de arranque ("0") ó Start bit, que la impresora utiliza para iniciar la impresión, y le indica el comienzo de cada carácter de información.
Un bit de parada ("1") ó Stop bit, con el que la impresora identifica el fin de cada carácter de información, deteniendo la impresión.

NOMBRE
 FUNCIÓN
 
TxD
Línea de transmisión serie:
Transmite datos en series de bits enviados al ordenador desde la impresora.
RxD
 
Línea de recepción serie:
Datos en series de bits transmitidos a la impresora desde el ordenador.
 
DTR
Data Terminal Ready (Terminal de Datos Preparada):
Línea de salida que habilita e inhabilita la transmisión de datos a la impresora, al activarse y desactivarse, respectivamente.
 


Dos posibles protocolos de comunicación:
- El protocolo del software XON/XOFF. - El protocolo del hardware DTR.


- Protocolo XON/XOFF:
Este protocolo utiliza únicamente las señales TxD y RxD. Cuando el buffer está lleno, la impresora envía el carácter XOFF (13H) a través de la línea TxD, para indicar que se debe detener la transmisión de datos. Una vez enviado el carácter XOFF, la impresora sigue imprimiendo, creando así sitio en el buffer. Cuando hay espacio en el buffer, la impresora reanuda la transmisión de datos enviando el carácter XON (11H).
- Protocolo DTR:
En este caso, se utiliza la línea DTR para indicar cuando se debe iniciar y suspender la transmisión de datos. Cuando el buffer está lleno, la impresora retira la señal DTR para suspender la transmisión. Cuando se crea sitio en el buffer, la impresora activa DTR para reanudar la transmisión de datos.
En el anexo se presentan los 4 casos usando USART y la impresora serie. Estos son protocolo DTR vía consulta de estado e interrupción, y XON / XOFF mediante consulta de estado e interrupción.



- Protocolo DTR vía consulta de estado:
Se configura la USART con el numero binario 01010001 en el registro de control (62H). Esto implica que se trabajara con error reset (bit 6 en 1), DTR activado (bit 4 en 1) y comunicación asíncrona (bit 0 en 1). Luego continuo en un lazo de consulta de estado para saber cuándo la impresora esta lista para el próximo carácter. Esto lo logro consultando por el bit más significativo y el menos significativo del registro de control de la USART (62H) ya que el primero, Data Set Ready, es el estado del dato de entrada y el último, TrxReady, en 1 está vacío, se espera que cambie a 0 (lleno). Cada vez que se cumplan ambas condiciones, sale del bucle de consulta y se procede a imprimir el siguiente carácter repitiendo el proceso de consulta hasta terminar de imprimir la cadena completa.
A continuación se describe detalladamente cada ejemplo:
- Protocolo DTR vía interrupción:
Se activan las interrupciones habilitando la USART para interrumpir y le se indica el inicio de la subrutina para atender dicha interrupción. Configuro la USART con el numero binario 01010101 en el registro de control (62H). Esto implica que se trabajara con error reset (bit 6 en 1), DTR activado (bit 4 en 1), TrxRdy activado (bit 2 en 1) comunicación asíncrona (bit 0 en 1). Luego espero que se genera dicha interrupción en un bucle consultando si se activó DSR (Data Set Ready, el bit más significativo). Esto sucede cuando el periférico está listo para interactuar. Una vez recibida esta señal, se debe solicitar el envío, RTS (Request To Send). Luego, de manera automática la USART genera la senial de aceptación de del pedido anterior, llamada CTS (Clear To Send), avisando que ya puede iniciar la transferencia de caracteres. Finalmente espero en un lazo a que se genere la interrupción e imprima la cadena. Dentro de la subrutina de atención a dicha interrupción, se envía a la impresora de a un carácter por vez; en una única interrupción se realiza la impresión del mensaje completo.
- Protocolo xon/xoff por consulta de estado:
Se configura la USART con el numero 51H (en binario 01010001 en el registro de control (62H). Esto implica trabajar con error reset (bit 6 en 1), DTR activado (bit 4 en 1) y comunicación asíncrona (bit 0 en 1). Luego en un lazo espero a que se envíe el carácter a la impresora. Esto es, cuando Txrdy cambia a 1 y se vacía el registro de salida (se ha enviado a imprimir el carácter). Al suceder lo anterior, resto el contador decaracteres de la cadena y verifico si faltan imprimir. En otro lazo consulto si el buffer de la impresora esta lleno. SI aún hay lugar, envio otro carácter. Caso contrario (se ha activado Rxrdy) la impresora transmite un carácter al CPU avisando cual es su estado. Si ha enviado ‘xon’, significa que ya se liberó espacio en el buffer y puede continuar la impresión. Si por otro lado recibió ‘xoff’, el buffer continua lleno y debo esperar que se genere lugar (otro bucle de consulta).
- Protocolo xon/xoff vía interrupción:
Configuro la atención de interrupciones, en este caso INT2 (línea Rxrdy) e INT3 (línea Txrdy) permitiendo la recepción y transmisión de la USART, respectivamente; habilito ambas en el IMR. Se configura el registro de control (62H) de la USART con el numero 7DH (en binario 01111101). Esto implica trabajar con error reset (bit 6 en 1), RTS (bit 5 en 1), DTR activado (bit 4 en 1), Rxrdy (bit 3 en 1), Txrdy (bit 2 en 1) y comunicación asíncrona (bit 0 en 1). Al configurarlo se dispara la interrupción INT3 debido al valor 1 en RTS (genera el pedido de atención de interrupción al PIC). Al hacerlo se está solicitando el envío y a la espera de un CTS (Clear To Send) para iniciar la transferencia. En nuestro simulador ambas líneas son manejadas por la misma USART y por ello, al activar RTS automáticamente se activa un CTS a continuación. Luego sólo resta esperar a que finalice la impresión ejecutando las subrutinas de interrupción. En la subrutina de transmisión se envía un carácter a imprimir, se resta uno del contador de caracteres y, si ya se ha impreso el mensaje completo, se activa la variable centinela FLAG para al finalizar. Si en algún momento se genera el pedido de interrupción INT2, la impresora tiene el buffer lleno y se ejecuta la interrupción de recepción comprobándose el carácter enviado. Si es un ‘xon’, finalizó la interrupción ya que ya hay lugar disponible en el buffer. Si es un ‘xoff’, debo poner en 0 RTS (y CTS automáticamente) en el registro de control de la USART. Esto evita que ésta continúe enviando caracteres y la eventual pérdida de los mismos (la impresora no tiene lugar para almacenarlos, buffer lleno). Recién cuando se vuelva a solicitar esta interrupción vía INT2 y el carácter enviado sea un ‘xon’, se continúa con el envío de los caracteres restantes. Al recibir dicho ‘xon’ se activa RTS (y CTS automáticamente).


